\chapter{数据处理的概率论基础}

前面的章节我们介绍了最基本的数据模型——线性模型。
从中可以发现线性回归的关键在于处理数据中的噪音和误差；没有噪音和误差数据和模型应该完美吻合，不需要线性回归求近似解。噪音和误差的本质都是不确定性，而量化不确定性最有效的数学工具是概率论，因此本章我们补充一些数据处理的概率论基础。

\section{什么是概率}
概率论的研究对象自然是\emph{概率}。
概率的基本含义很容易理解，概率是一个$0$到$1$之间的实数，代表某件事情发生的可能性——数字越大代表事件发生的可能性越大，两个极端分别是概率$0$，事情绝对不会发生，概率$1$，事情一定会发生。
但要进行严密的数学分析需要对概率的意义做严格的定义，这就没有那么符合直觉了。例如概率$0.85$代表什么意思？

关于概率的定义历史上有过很长时间的争论，一直到今天都存在两种互相竞争的定义，一种是基于\emph{频率}的概率，简称\emph{频率概率}，另一种是基于\emph{贝叶斯公式}的概率，简称\emph{贝叶斯概率}。用一句话总结
\begin{itemize}
    \item 前者认为概率是重复实验中频率的极限；
    \item 后者认为概率是一个用贝叶斯公式反复修正后的数字。
\end{itemize}
两种概率定义在很多应用中是等价的，但是两者背后隐含了非常不同的哲学思考，在另一些应用中会得到不同的结果。

\subsection{频率概率}

频率的定义来自于重复实验。假设某种试验一共有$M$种可能的结果，分别用自然数$i\in\{1,2,\cdots, M\}$表示。将试验重复进行$N$次，统计后结果为$i$的次数记为$n_i$，$i$出现的\emph{频率（frequency）}记为
\begin{equation}
    f_i=\frac{N_i}{N}。
\end{equation}

由于每次试验的结果随机，因此试验总次数$N$不同时频率$f_i$也会变化。但是概率论的一个基本假设是，随着试验重复次数$N$趋于无穷大，频率$f_i$会收敛于一个确定值这个值就是结果$i$的\emph{概率（probability）}
\begin{equation}
    p_i=\lim_{N\to\infty}f_i=\lim_{N\to\infty}\frac{n_i}{N}。
\end{equation}


凭率概率最大的优势是它的定义建立在重复试验上，具有\emph{客观性}，因为无论是重复试验还是结果计数都与实验者的主观意愿无关。
由于客观性这个优势，频率概率在很长时间内占据了概率论研究的主流。

频率概率的最大问题也来自于重复试验，因为在实际应用中会遇到很多数据背后的试验无法重复的情况。
例如天文学数据来自对天文现象的观测，而很多天文想象的周期远超过天文学家的寿命，甚至超过人类历史的长度；
或者安全事故数据来自于飞机轮船灾难，我们既不知道灾难以后什么时候会发生，也不希望它发生，更不能主动安排它发生。对于这些情况贝叶斯概率更加适合。

\subsection{贝叶斯概率}
贝叶斯概率来自于\emph{贝叶斯贝叶斯公式}\sidenote{公式以发现者托马斯·贝叶斯牧师（Thomas Bayes）的名字命名}
\begin{equation}\label{eq:bayes}
    P(A|B)=\frac{P(B|A)P(A)}{P(B)}
\end{equation}
其中$A$、$B$是两个不同的事件；$P(\cdot)$是概率函数，以事件为输入，输出$0$到$1$之间的数字表示该事件发生的可能性。

\subsubsection{推导}
贝叶斯公式来自于更基础的\emph{条件概率公式}
\begin{equation}\label{eq:conditional1}
    P(AB)=P(A)P(B|A)。
\end{equation}
即$A$、$B$两个事件同时发生的概率$P(AB)$，等于$A$事件单独发生的概率$P(A)$乘以$A$事件发生的条件下$B$事件发生的概率$P(B|A)$。
同时我们注意到\cref{eq:conditional1}中$A$、$B$是对称的，因此可以交换两个符号得到
\begin{equation}\label{eq:conditional2}
    P(BA)=P(B)P(A|B)。
\end{equation}

根据定义，$A$、$B$同时发生的概率应该等于$B$、$A$同时发生的概率，因此我们有
\begin{align}
    P(BA)&=P(AB)，\\
    \intertext{代入\cref{eq:conditional1}和\cref{eq:conditional2}得到}
    P(B)P(A|B) &= P(A)P(B|A)。
\end{align}
两边同时除以$P(B)$就能得到\cref{eq:bayes}。

\subsubsection{解读}
为了方便理解贝叶斯公式的重要意义，我们把\cref{eq:bayes}中的符号$A$、$B$替换为$H$、$D$，其中$H$表示\emph{假说（Hypothesis）}，$D$表示\emph{数据（Data）}，由此贝叶斯公式写作
\begin{equation}\label{eq:bayes-hd}
    P(H|D)=\frac{P(D|H)P(H)}{P(D)}。
\end{equation}
此时公式中的四个组成部分都有了实际意义，其中：
\begin{itemize}
    \item $P(H)$称为\emph{先验概率（prior）}，表示在不考虑任何数据的情况下，分析者对某假说$H$成立可能性的\emph{主观}评价；
    \item $P(H|D)$称为\emph{后验概率（posterior）}，表示在考虑数据后，分析者对假说成立可能性的评价；
    \item $P(D|H)$称为\emph{似然概率（likelihood）}，表示如果假说$H$成立，观察到数据$D$的可能性；
    \item $P(D)$称为\emph{全数据概率（evidence）}，表示综合考虑假说$H$是否成立后，观察到数据$D$的概率。
\end{itemize}

注意，在贝叶斯概率的定义里并没有告诉我们如何去确定先验概率和似然概率的值%
\sidenote{全数据概率$P(D)$通常被忽略，见\cref{eq:bayes-propto}。}
，只是告诉我们假设两个概率确定后如何用似然概率去修正先验概率得到后验概率。

\section{应用贝叶斯概率}

贝叶斯公式的重要意义在于提供了一种工具，让我们从主观判断出发，利用数据对我们的判断进行修正，得到更接近于事实的判断。
例如对于某个问题我们知道一共有三种可能的答案$A$、$B$、$C$，但不确定正确答案是哪一个。
我们可以把这个不确定的答案称为\emph{随机变量}$X$，由此得到三个不同的假设
\begin{equation*}
    H_A:X=A,\qquad H_B:X=B,\qquad H_C:X=C。
\end{equation*}

我们从主观判断出发，可以随意给定三个假说的先验概率$P(H_A)$、$P(H_B)$、$P(H_C)$，唯一的要求是三者之和为$1$，即$P(H_A)+P(H_B)+P(H_C)=1$，因为三个假说必有一个成立。
接下来为了利用贝叶斯公式我们需要采用某种方法获取似然概率$P(D|H_A)$、$P(D|H_B)$、$P(D|H_C)$，但另一方面全数据概率却$P(D)$可以直接确定。因为三个后验概率之和也要为$1$，即
\begin{equation*}
    P(H_A|D)+P(H_B|D)+P(H_C|D)=1，
\end{equation*}
带入\cref{eq:bayes-hd}得到
\begin{equation}
    \frac{P(D|H_A)P(H_A)}{P(D)}+\frac{P(D|H_B)P(H_B)}{P(D)}+\frac{P(D|H_C)P(H_C)}{P(D)}=1。
\end{equation}
可以看出$P(D)$只是保证后验概率之和为$1$的\emph{归一化（normalization）}系数，一旦先验概率和似然概率确定，它的值也自动确定。

因此我们常常省去全数据概率$P(D)$，将\cref{eq:bayes-hd}简写成
\begin{equation}\label{eq:bayes-propto}
    P(H|D)\propto P(D|H)P(H)，
\end{equation}
其中$\propto$读作“正比于”。
贝叶斯公式读作“后验概率正比于先验概率与似然概率的乘积”。

贝叶斯估计的思想在现实生活中广泛存在。在《血字的研究》第二章中，福尔摩斯通过推理确定华生来自阿富汗时就不自觉的使用了贝叶斯估计的原理：
\begin{quotation}
    “在你这件事上，我的推理过程是这样的：‘这一位先生，具有医务工作者的风度，但却是一副军人气概。那么，显见他是个军医。他是刚从热带回来，因为他脸色黝黑，但是，从他手腕的皮肤黑白分明看来，这并不是他原来的肤色。他面容憔悴，这就清楚地说明他是久病初愈而又历尽了艰苦。他左臂受过伤，现在动作品来还有些僵硬不便。试问，一个英国的军医在热带地方历尽艰苦，并且臂部负过伤，这能在什么地方呢？自然只有在阿富汗了。’这一连串的思想，历时不到一秒钟，因此我便脱口说出你是从阿富汗来的，你当时还感到惊破哩。”
\end{quotation}
接下来我们用贝叶斯概率的思想重现福尔摩斯的推理过程。

\subsubsection{确定问题和可能答案}

这里福尔摩斯面临的问题$X$是“华生来自于哪个国家”；这个问题的答案集合$S$理论上包括当时世界上所有国家，但是福尔摩斯可以利用华生的军医身份，把范围限定在近期有过英国驻军的国家，例如
\begin{equation*}
S=\{印度，爱尔兰，南非，阿富汗\}。
\end{equation*}
缩小答案数量并非必须，但可以减少分析篇幅。

\subsubsection{确定先验概率}

接下来福尔摩斯可以指定四个答案正确的先验概率$P(H_i)，i\in S$。
根据先验概率的定义，此时福尔摩斯还没有参考任何数据和证据，没有理由觉得某个答案比另一个答案更好，因此最合理的假设是所有答案的先验概率相等，即
\begin{equation*}
    P(H_{印度})=\frac{1}{4}\qquad P(H_{爱尔兰})=\frac{1}{4}\qquad P(H_{南非})=\frac{1}{4}\qquad P(H_{阿富汗})=\frac{1}{4}。
\end{equation*}
其中$H_{印度}$代表假说$X=印度$。

在贝叶斯估计过程中我们往往不用概率，而是比例表示不同答案之间可能性的大小，因为比例更符合我们日常的思考习惯，例如这里我们会想“四个答案一样好，因此先验概率的比例是$(1:1:1:1$)”。
比例通过归一化可以转化为概率，但为了方便我们一般把归一化推迟到最后。

\subsubsection{确定似然概率}

下一步福尔摩斯需要根据军事、政治、地理知识来确定似然概率$P(D|H_i)，i\in S$。
根据整段文字，福尔摩斯并做出决策并非基于单一证据，而是综合考虑了以下三条证据：
\begin{itemize}
    \item “手腕白”，“脸黑”，说明是被晒黑的；
    \item “受伤”，说明发生过战斗；
    \item “憔悴”，“历经了艰苦”，说明后勤补给困难，战场环境艰苦。
\end{itemize}
三条证据分别记做$D_{晒黑}$，$D_{战斗}$，$D_{艰苦}$，那么似然概率
\begin{equation*}
    P(D|H_i)=P(D_{晒黑}D_{战斗}D_{艰苦}|H_i)。
\end{equation*}

一般假设多条证据\emph{相互独立}，此时复合证据的似然概率可以分解为各证据似然概率的乘积，即
\begin{equation}
    P(D|H_i)=P(D_{晒黑}|H_i)P(D_{战斗}|H_i)P(D_{艰苦}|H_i)。
\end{equation}
分解后，单个证据的似然概率更容易确定。
\begin{itemize}
    \item 对于晒黑，根据地理知识我们知道越靠近赤道紫外线越强，越容易晒黑。
    因此四个答案中纬度越低的国家似然概率应该越大，比如可以分别取值$(10:1:3:5)$。
    \item 对于战斗，根据当时国际局势我们知道英国在印度和爱尔兰的统治更加稳固发生战斗的可能性小，而在南非和阿富汗发生战斗的可能性大，可以分别取值$(1:1:4:5)$。
    \item 对于憔悴，根据对英国军事策略的了解，我们知道由于英国海军的优势，越是靠近海岸补给就约容易，越是深入内陆补给越困难，可以分别取值$2:1:3:8$。
\end{itemize}

\subsubsection{计算后验概率}
\begin{table}
    \ContinuedFloat* %必须，不然编号出错，见caption宏包
    \sidecaption{贝叶斯估计过程。}
    \begin{tabular}{lcccc}
        \toprule
        & $X=印度$ & $X=爱尔兰$ & $X=南非$ & $X=阿富汗$\\
        \midrule
        先验$P(H_i)$ & 1 & 1 & 1 & 1\\
        先验$P(D_{晒黑}|H_i)$ & 10 & 1 & 3 & 5 \\
        似然$P(D_{战斗}|H_i)$ & 1 & 1 & 4 & 5\\
        似然$P(D_{艰苦}|H_i)$ & 2 & 1 & 3 & 8\\
        \midrule
        后验$P(H_i|D)$ & 20 & 1 & 36 & 200\\
        归一化 & 0.078 & 0.003 & 0.14 & 0.778\\
        \bottomrule
    \end{tabular}
    \label{tab:bayes}
\end{table}

先验概率和似然概率整理之后如\cref{tab:bayes}所示，将每一列连乘得到后验概率的比例。
最后归一化得到后验概率。从中可以看到阿富汗的概率$0.778$远高于其他答案，因此福尔摩斯得到了他的答案。


